name: Pipeline Example With 2MS
on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  secrets-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0

      - name: ğŸ” Run 2MS Secret Scanning
        run: |
          echo "=========================================="
          echo "ğŸ” 2MS SECRET SCANNING - DEMO"
          echo "=========================================="
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Timestamp: $(date)"
          echo "=========================================="
          echo ""
          
          echo "ğŸš€ Starting comprehensive secret scan..."
          echo ""
          
          # Run 2MS and capture output
          docker run -v $(pwd):/repo checkmarx/2ms:2.8.1 git /repo --output-format table 2>&1 | tee 2ms-output.txt || true
          
          echo ""
          echo "=========================================="
          echo "ğŸ“Š SCAN SUMMARY"
          echo "=========================================="
          
          # Count potential findings (rough estimate from output)
          FINDINGS=$(grep -c "Secret found" 2ms-output.txt 2>/dev/null || echo "0")
          
          if [ -s "2ms-output.txt" ] && grep -q "Secret found\|Finding" 2ms-output.txt 2>/dev/null; then
            echo "ğŸš¨ POTENTIAL SECRETS DETECTED!"
            echo ""
            echo "ğŸ“‹ Full scan results above â˜ï¸"
            echo ""
            echo "âš ï¸  Please review these findings and:"
            echo "   â€¢ Remove any real secrets from code"
            echo "   â€¢ Use environment variables for sensitive data"
            echo "   â€¢ Consider using secret management tools"
            echo ""
            echo "ğŸ”’ Security is everyone's responsibility!"
          else
            echo "âœ… No obvious secrets detected in repository"
            echo ""
            echo "â„¹ï¸  This doesn't guarantee the absence of all secrets."
            echo "   Always follow security best practices!"
          fi
          
          echo ""
          echo "=========================================="
          echo "âœ… 2MS Secret Scan Complete"
          echo "=========================================="

      - name: Create Summary Report
        run: |
          echo "## ğŸ” 2MS Secret Scanning Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if grep -q "Secret found\|Finding" 2ms-output.txt 2>/dev/null; then
            echo "### ğŸš¨ Findings Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The scan detected potential secrets in your repository." >> $GITHUB_STEP_SUMMARY
            echo "Please review the detailed output in the workflow logs." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Recommended Actions:**" >> $GITHUB_STEP_SUMMARY
            echo "- Remove any hardcoded secrets" >> $GITHUB_STEP_SUMMARY
            echo "- Use environment variables or secret management" >> $GITHUB_STEP_SUMMARY
            echo "- Review commit history for exposed secrets" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… No Obvious Secrets Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The scan completed without detecting obvious secrets." >> $GITHUB_STEP_SUMMARY
            echo "Continue following security best practices!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“ Upload Scan Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: 2ms-scan-output
          path: 2ms-output.txt
          retention-days: 30